<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é£Ÿæè³å‘³æœŸé™ç®¡ç† </title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            color: #343a40;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

            .navigation-buttons button {
                flex: 1;
                padding: 12px 20px;
                font-size: 16px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

                .navigation-buttons button:hover {
                    background-color: #0056b3;
                    transform: translateY(-2px);
                }

                .navigation-buttons button.active {
                    background-color: #004494;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
                }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡ */
        section {
            display: none;
        }

            section.active {
                display: block;
            }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        form div {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"], input[type="date"] {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
        }

        button[type="submit"] {
            background-color: #28a745;
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            font-weight: bold;
        }

            button[type="submit"]:hover {
                background-color: #218838;
            }

        /* ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ */
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

            .category-buttons button {
                padding: 8px 18px;
                font-size: 14px;
                background: #e9ecef;
                color: #495057;
                border: 1px solid #ced4da;
                border-radius: 20px;
                cursor: pointer;
            }

                .category-buttons button.active {
                    background: #007bff;
                    color: #fff;
                    border-color: #007bff;
                }

        /* ãƒªã‚¹ãƒˆãƒ»ã‚«ãƒ¼ãƒ‰è¡¨ç¤º */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .item-card {
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            position: relative;
            border: 1px solid #eee;
        }

            .item-card h4 {
                font-size: 1em;
                margin: 0 0 5px 0;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .item-card p {
                font-size: 0.85em;
                margin: 0 0 3px 0;
            }

        .item-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .expiry-status {
            font-size: 0.8em;
            font-weight: bold;
            display: block;
            text-align: right;
        }

        .expired {
            color: #dc3545;
        }

        .near-expiry {
            color: #fd7e14;
        }

        .ok-expiry {
            color: #28a745;
        }

        .delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆ */
        .search-and-sort-container {
            margin-bottom: 20px;
        }

        #search-input {
            margin-bottom: 10px;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
        }

            .sort-buttons button {
                padding: 8px 12px;
                border: 1px solid #ced4da;
                border-radius: 6px;
                background: #fff;
                cursor: pointer;
            }

                .sort-buttons button.active {
                    background: #007bff;
                    color: #fff;
                }

        #camera-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        .camera-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        #camera-feed-overlay {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ã‚¬ã‚¤ãƒ‰æ  */
        .target-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #0f0;
            box-shadow: 0 0 0 999px rgba(0, 0, 0, 0.6);
            z-index: 10;
            transition: all 0.3s ease;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯é€é */
        }

        .box-date {
            width: 70%;
            height: 15%;
            border-color: #ffc107;
        }
        /* é»„è‰²ï¼šæœŸé™ */
        .box-name {
            width: 85%;
            height: 40%;
            border-color: #0dcaf0;
        }
        /* æ°´è‰²ï¼šå•†å“å */

        .guide-text {
            position: absolute;
            top: -40px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #fff;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            font-size: 1.2rem;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .scan-control-panel {
            background: #fff;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            margin-top: -20px;
            z-index: 20;
            text-align: center;
        }

        .scan-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .badge-warning {
            background-color: #ffc107;
            color: #000;
        }

        .badge-info {
            background-color: #0dcaf0;
            color: #000;
        }

        .scan-results-preview {
            text-align: left;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }

        .btn-yellow {
            background-color: #ffc107;
            color: #000;
        }

            .btn-yellow:hover {
                background-color: #e0a800;
            }

        .btn-blue {
            background-color: #0dcaf0;
            color: #000;
        }

            .btn-blue:hover {
                background-color: #3dd5f3;
            }

        .skip-btn {
            background: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 8px;
            width: 100%;
            margin-top: 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .close-scan-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 50;
            background: rgba(0,0,0,0.5);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .scan-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
            display: none;
        }

        .d-none {
            display: none !important;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ä¸Šã®ã‚µãƒ ãƒã‚¤ãƒ« */
        #form-preview-image {
            display: block;
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            background: #eee;
            border-radius: 8px;
            margin-top: 5px;
        }

        /* èµ·å‹•ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .start-scan-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .start-scan-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }
    </style>
</head>
<body>

    <div class="container">
        <h1>é£Ÿæè³å‘³æœŸé™ç®¡ç†</h1>

        <div class="navigation-buttons">
            <button id="show-add-item-btn">é£Ÿæç™»éŒ²</button>
            <button id="show-item-list-btn" class="active">é£Ÿæç®¡ç†</button>
        </div>

        <!-- é£Ÿæç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="add-item">
            <h2>æ–°ã—ã„é£Ÿæã‚’è¿½åŠ </h2>

            <!-- é«˜æ©Ÿèƒ½ã‚¹ã‚­ãƒ£ãƒ³èµ·å‹•ãƒœã‚¿ãƒ³ -->
            <button type="button" id="open-scan-overlay-btn" class="start-scan-btn">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                ã‚«ãƒ¡ãƒ©ã§æœŸé™ã¨å•†å“åã‚’ã‚¹ã‚­ãƒ£ãƒ³
            </button>

            <form id="item-form">
                <div>
                    <label>å†™çœŸ (ã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰):</label>
                    <img id="form-preview-image" src="" alt="å•†å“å†™çœŸ(æœªè¨­å®š)" style="display:none;">
                    <input type="hidden" id="item-image-data" name="itemImageData" />
                </div>

                <div>
                    <label for="item-name">é£Ÿæå:</label>
                    <input type="text" id="item-name" name="itemName" placeholder="ã‚¹ã‚­ãƒ£ãƒ³ã§è‡ªå‹•å…¥åŠ›ã€ã¾ãŸã¯æ‰‹å…¥åŠ›" required />
                </div>

                <div>
                    <label for="expiry-date">è³å‘³æœŸé™:</label>
                    <input type="date" id="expiry-date" name="expiryDate" required />
                </div>

                <div>
                    <label>ã‚«ãƒ†ã‚´ãƒª:</label>
                    <div class="category-buttons">
                        <button type="button" data-category="é‡èœ">é‡èœ</button>
                        <button type="button" data-category="è‚‰é¡">è‚‰é¡</button>
                        <button type="button" data-category="é­šé¡">é­šé¡</button>
                        <button type="button" data-category="ä¹³è£½å“">ä¹³è£½å“</button>
                        <button type="button" data-category="èª¿å‘³æ–™">èª¿å‘³æ–™</button>
                        <button type="button" data-category="é£²æ–™">é£²æ–™</button>
                        <button type="button" data-category="ã‚¢ã‚¤ã‚¹">ã‚¢ã‚¤ã‚¹</button>
                        <button type="button" data-category="æœç‰©">æœç‰©</button>
                        <button type="button" data-category="å†·å‡é£Ÿå“">å†·å‡é£Ÿå“</button>
                        <button type="button" data-category="è“å­">è“å­</button>
                        <button type="button" data-category="éººé¡">éººé¡</button>
                        <button type="button" data-category="ãƒ‘ãƒ³">ãƒ‘ãƒ³</button>
                        <button type="button" data-category="ãã®ä»–" class="active">ãã®ä»–</button>
                    </div>
                    <input type="text" id="custom-category" placeholder="ã¾ãŸã¯æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›" style="margin-top: 10px;" />

                    <input type="hidden" id="item-category" name="itemCategory" value="ãã®ä»–" />
                </div>

                <button type="submit">ä¿å­˜ã™ã‚‹</button>
            </form>
        </section>

        <!-- é£Ÿæä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section id="item-list" class="active">
            <h2>ç™»éŒ²æ¸ˆã¿é£Ÿæ</h2>
            <div class="search-and-sort-container">
                <input type="text" id="search-input" placeholder="é£Ÿæåã‚’æ¤œç´¢..." />
                <div class="sort-buttons">
                    <button id="sort-by-near-expiry" class="active">æœŸé™ãŒè¿‘ã„é †</button>
                    <button id="sort-by-category">ã‚«ãƒ†ã‚´ãƒªé †</button>
                </div>
            </div>
            <div id="items-by-category"></div>
        </section>

        <!-- é€šçŸ¥è¨­å®š -->
        <div id="notification-settings" style="margin-top: 30px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px;">
            <h3 style="font-size:1.1em; border:none; margin:0 0 10px 0;">ğŸ”” é€šçŸ¥è¨­å®š (æœŸé™3æ—¥å‰)</h3>
            <p id="notification-status" style="margin:0 0 10px 0; font-size:0.9em;">é€šçŸ¥çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</p>
            <button type="button" id="request-notification-permission"
                    style="background-color: #ffc107; color: #343a40; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
                é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹
            </button>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ã‚³ãƒ¼ãƒ‰1ã®æ©Ÿèƒ½) -->
    <!-- ========================================== -->
    <div id="camera-overlay" class="d-none">
        <button id="close-scan-btn" class="close-scan-btn">âœ• é–‰ã˜ã‚‹</button>

        <div class="camera-wrapper">
            <video id="cameraFeed" autoplay playsinline muted></video>

            <!-- ã‚¬ã‚¤ãƒ‰æ  -->
            <div id="targetBox" class="target-box box-date">
                <div id="guideText" class="guide-text">Step 1: è³å‘³æœŸé™</div>
            </div>

            <!-- æ’®å½±ç”¨Canvas (éè¡¨ç¤º) -->
            <canvas id="captureCanvas" style="display: none;"></canvas>
        </div>

        <div class="scan-control-panel">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º -->
            <div class="mb-2">
                <span id="stepBadge" class="scan-badge badge-warning">STEP 1/2</span>
            </div>

            <!-- é€”ä¸­çµŒéè¡¨ç¤º -->
            <div class="scan-results-preview">
                <small class="text-muted">è³å‘³æœŸé™:</small> <span id="tempDateResult" style="font-weight:bold;">---</span><br>
                <small class="text-muted">å•†å“å:</small> <span id="tempNameResult" style="font-weight:bold;">---</span>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="scanError" class="scan-error">
                <strong>èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</strong><br>
                å†è©¦è¡Œã™ã‚‹ã‹ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <button id="actionBtn" class="action-btn btn-yellow">
                <span class="btn-text">è³å‘³æœŸé™ã‚’ã‚¹ã‚­ãƒ£ãƒ³</span>
            </button>

            <!-- ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
            <button id="skipBtn" class="skip-btn d-none">
                æ‰‹å…¥åŠ›ã™ã‚‹ (ã‚¹ã‚­ãƒƒãƒ—)
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // å¤‰æ•°ç®¡ç† (ã‚¢ãƒ—ãƒªå…¨ä½“)
            let foodItems = JSON.parse(localStorage.getItem('foodItems')) || [];
            let currentSortOrder = 'near-expiry';

            // å¤‰æ•°ç®¡ç†
            let currentStep = 0; // 0:æœŸé™, 1:å•†å“å
            let scannedDate = "";
            let scannedName = "";
            let productBlob = null; // æ’®å½±ç”»åƒ
            let stream = null; // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ 

            //DOMè¦ç´ å–å¾—
            const showAddItemBtn = document.getElementById('show-add-item-btn');
            const showItemListBtn = document.getElementById('show-item-list-btn');
            const addItemSection = document.getElementById('add-item');
            const itemListSection = document.getElementById('item-list');
            const itemForm = document.getElementById('item-form');
            const itemsByCategoryDiv = document.getElementById('items-by-category');
            const categoryButtons = document.querySelectorAll('.category-buttons button');
            const itemCategoryInput = document.getElementById('item-category');
            const customCategoryInput = document.getElementById('custom-category');
            const sortButtons = document.querySelectorAll('.sort-buttons button');
            const searchInput = document.getElementById('search-input');

            const itemNameInput = document.getElementById('item-name');
            const expiryDateInput = document.getElementById('expiry-date');
            const formPreviewImage = document.getElementById('form-preview-image');
            const itemImageDataInput = document.getElementById('item-image-data');

            // DOMè¦ç´ å–å¾—
            const openScanBtn = document.getElementById('open-scan-overlay-btn');
            const cameraOverlay = document.getElementById('camera-overlay');
            const closeScanBtn = document.getElementById('close-scan-btn');

            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('captureCanvas');
            const targetBox = document.getElementById('targetBox');
            const guideText = document.getElementById('guideText');
            const actionBtn = document.getElementById('actionBtn');
            const skipBtn = document.getElementById('skipBtn');
            const stepBadge = document.getElementById('stepBadge');
            const scanError = document.getElementById('scanError');
            const tempDateResult = document.getElementById('tempDateResult');
            const tempNameResult = document.getElementById('tempNameResult');

            function switchSection(activeSection, activeBtn) {
                document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.navigation-buttons button').forEach(b => b.classList.remove('active'));
                activeSection.classList.add('active');
                activeBtn.classList.add('active');
            }

            showAddItemBtn.addEventListener('click', () => switchSection(addItemSection, showAddItemBtn));
            showItemListBtn.addEventListener('click', () => {
                renderItems();
                switchSection(itemListSection, showItemListBtn);
            });

            // ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒœã‚¿ãƒ³
            categoryButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    categoryButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    const selectedValue = e.target.dataset.category;
                    itemCategoryInput.value = selectedValue;
                    customCategoryInput.value = selectedValue; // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚‚åæ˜ 
                });
            });

            // ã‚«ãƒ†ã‚´ãƒªæ‰‹å…¥åŠ›æ™‚ã®å‹•ä½œ
            customCategoryInput.addEventListener('input', (e) => {
                const value = e.target.value;
                itemCategoryInput.value = value;

                // å…¥åŠ›ã—ãŸæ–‡å­—ãŒæ—¢å­˜ã®ãƒœã‚¿ãƒ³åã¨ä¸€è‡´ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’å…‰ã‚‰ã›ã‚‹
                categoryButtons.forEach(btn => {
                    if (btn.dataset.category === value) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });

            // ã‚½ãƒ¼ãƒˆ
            sortButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    sortButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentSortOrder = e.target.id.replace('sort-by-', '');
                    renderItems();
                });
            });
            searchInput.addEventListener('input', renderItems);

            // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º)
            openScanBtn.addEventListener('click', async () => {
                cameraOverlay.classList.remove('d-none');
                resetScanState();
                await startCamera();
            });

            // ã‚¹ã‚­ãƒ£ãƒ³çµ‚äº† (é–‰ã˜ã‚‹)
            closeScanBtn.addEventListener('click', () => {
                stopCamera();
                cameraOverlay.classList.add('d-none');
            });

            async function startCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                    video.srcObject = stream;
                } catch (err) {
                    console.error(err);
                    alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚HTTPSæ¥ç¶šã¾ãŸã¯localhostã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    cameraOverlay.classList.add('d-none');
                }
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.srcObject = null;
            }

            function resetScanState() {
                currentStep = 0;
                scannedDate = "";
                scannedName = "";
                productBlob = null;

                // UIãƒªã‚»ãƒƒãƒˆ
                tempDateResult.textContent = "---";
                tempNameResult.textContent = "---";
                scanError.classList.add('d-none');
                skipBtn.classList.add('d-none');

                // UI
                targetBox.className = 'target-box box-date';
                guideText.textContent = 'Step 1: è³å‘³æœŸé™';
                stepBadge.textContent = 'STEP 1/2';
                stepBadge.className = 'scan-badge badge-warning';

                actionBtn.className = 'action-btn btn-yellow';
                actionBtn.querySelector('.btn-text').textContent = 'è³å‘³æœŸé™ã‚’ã‚¹ã‚­ãƒ£ãƒ³';
                actionBtn.disabled = false;
            }

            // ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œãƒœã‚¿ãƒ³
            actionBtn.addEventListener('click', async () => {
                actionBtn.disabled = true;
                actionBtn.querySelector('.btn-text').textContent = 'èª­ã¿å–ã‚Šä¸­...';
                scanError.classList.add('d-none');

                // ã‚­ãƒ£ãƒ—ãƒãƒ£
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('file', blob);

                    //è³å‘³æœŸé™
                    if (currentStep === 0) {
                        try {
                            const res = await fetch('/api/ocr/date', { method: 'POST', body: formData });
                            if (!res.ok) throw new Error('API Error');
                            const data = await res.json();

                            if (data.success && data.result) {
                                scannedDate = data.result;
                                tempDateResult.textContent = scannedDate;
                                setupStep2();
                            } else {
                                throw new Error('No text detected');
                            }
                        } catch (e) {
                            console.log("OCR Error (Date):", e);
                            //  ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                            showScanError();
                        }
                    }
                    // å•†å“å 
                    else {
                        productBlob = blob; // æœ€æ–°ã®å†™çœŸã‚’ä¿å­˜
                        try {
                            const res = await fetch('/api/ocr/name', { method: 'POST', body: formData });
                            if (!res.ok) throw new Error('API Error');
                            const data = await res.json();

                            if (data.success && data.result) {
                                scannedName = data.result;
                                tempNameResult.textContent = scannedName;
                                finishScan();
                            } else {
                                throw new Error('No text detected');
                            }
                        } catch (e) {
                            console.log("OCR Error (Name):", e);
                            showScanError();
                        }
                    }
                    actionBtn.disabled = false;
                    const btnLabel = currentStep === 0 ? 'è³å‘³æœŸé™ã‚’ã‚¹ã‚­ãƒ£ãƒ³' : 'å•†å“åã‚’ã‚¹ã‚­ãƒ£ãƒ³';
                    actionBtn.querySelector('.btn-text').textContent = btnLabel;
                }, 'image/png');
            });

            // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³
            skipBtn.addEventListener('click', () => {
                scanError.classList.add('d-none');
                if (currentStep === 0) {
                    scannedDate = ""; // æ‰‹å…¥åŠ›å¾…ã¡
                    tempDateResult.textContent = "(æ‰‹å…¥åŠ›)";
                    setupStep2();
                } else {
                    // å•†å“åã‚¹ã‚­ãƒƒãƒ—æ™‚ã¯ã€ç›´å‰ã«æ’®ã‚ã†ã¨ã—ãŸå†™çœŸã‚’ç¢ºä¿
                    if (!productBlob) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => {
                            productBlob = blob;
                            scannedName = "";
                            finishScan();
                        });
                    } else {
                        scannedName = "";
                        finishScan();
                    }
                }
            });

            function showScanError() {
                scanError.classList.remove('d-none');
                skipBtn.classList.remove('d-none');
            }

            function setupStep2() {
                currentStep = 1;
                scanError.classList.add('d-none');
                skipBtn.classList.add('d-none');

                targetBox.className = 'target-box box-name';
                guideText.textContent = 'Step 2: å•†å“å';
                stepBadge.textContent = 'STEP 2/2';
                stepBadge.className = 'scan-badge badge-info';

                actionBtn.className = 'action-btn btn-blue';
                actionBtn.querySelector('.btn-text').textContent = 'å•†å“åã‚’ã‚¹ã‚­ãƒ£ãƒ³';
            }

            // ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
            function finishScan() {
                stopCamera();
                cameraOverlay.classList.add('d-none');

                // ãƒ•ã‚©ãƒ¼ãƒ ã¸å€¤ã‚’ã‚»ãƒƒãƒˆ
                if (scannedName) itemNameInput.value = scannedName;

                // æ—¥ä»˜è§£æã¨ã‚»ãƒƒãƒˆ (YYYY-MM-DDå½¢å¼ã«å¤‰æ›)
                if (scannedDate) {
                    const parsedDate = parseExpiryDate(scannedDate);
                    if (parsedDate) expiryDateInput.value = parsedDate;
                }

                // ç”»åƒå‡¦ç† (Blob -> DataURL -> Preview & Hidden Input)
                if (productBlob) {
                    const reader = new FileReader();
                    reader.onloadend = function () {
                        const base64data = reader.result;
                        formPreviewImage.src = base64data;
                        formPreviewImage.style.display = 'block';
                        itemImageDataInput.value = base64data;
                    }
                    reader.readAsDataURL(productBlob);
                }

                alert("ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼å†…å®¹ã‚’ç¢ºèªã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
            }

            // æ—¥ä»˜è§£æãƒ­ã‚¸ãƒƒã‚¯ (ã‚³ãƒ¼ãƒ‰2ç”±æ¥)
            function z2h(str) { return str.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); }
            function lastDayOfMonth(y, m) { return new Date(y, m, 0).getDate(); }
            function pad2(n) { return String(n).padStart(2, '0'); }
            function toISO(y, m, d) { return `${y}-${pad2(m)}-${pad2(d)}`; }
            function parseExpiryDate(raw) {
                const text = z2h(raw || '').replace(/\s+/g, '');
                let m;
                // 2025.11.23, 2025/11/23, 2025å¹´11æœˆ23æ—¥
                m = text.match(/(20\d{2}|19\d{2})[\.\/-å¹´](\d{1,2})[\.\/-æœˆ]?((\d{1,2})æ—¥?)?/);
                if (m) {
                    const y = parseInt(m[1], 10), mon = parseInt(m[2], 10);
                    const day = m[4] ? parseInt(m[4], 10) : lastDayOfMonth(y, mon);
                    if (mon >= 1 && mon <= 12) return toISO(y, mon, Math.min(day, lastDayOfMonth(y, mon)));
                }
                // 25.11.23 (YY.MM.DD)
                m = text.match(/(\d{2})[\.\/-](\d{1,2})(?:[\.\/-](\d{1,2}))?/);
                if (m) {
                    let yy = parseInt(m[1], 10), y = (yy < 80 ? 2000 + yy : 1900 + yy);
                    const mon = parseInt(m[2], 10);
                    const day = m[3] ? parseInt(m[3], 10) : lastDayOfMonth(y, mon);
                    if (mon >= 1 && mon <= 12) return toISO(y, mon, Math.min(day, lastDayOfMonth(y, mon)));
                }
                return null;
            }

            itemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = itemNameInput.value.trim();
                const expiry = expiryDateInput.value;
                const category = itemCategoryInput.value || 'ãã®ä»–';

                if (!name || !expiry) {
                    alert('é£Ÿæåã¨è³å‘³æœŸé™ã¯å¿…é ˆã§ã™ã€‚');
                    return;
                }

                const newItem = {
                    id: Date.now().toString(),
                    name,
                    category,
                    expiryDate: expiry,
                    image: itemImageDataInput.value || ''
                };

                foodItems.push(newItem);
                localStorage.setItem('foodItems', JSON.stringify(foodItems));

                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                itemForm.reset();
                formPreviewImage.src = "";
                formPreviewImage.style.display = "none";
                itemImageDataInput.value = "";
                categoryButtons.forEach(b => b.classList.remove('active'));
                document.querySelector('button[data-category="ãã®ä»–"]').classList.add('active');
                itemCategoryInput.value = "ãã®ä»–";

                alert('é£Ÿæã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                renderItems();
                showItemListBtn.click();
            });

            function renderItems() {
                itemsByCategoryDiv.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                const filteredItems = foodItems.filter(item =>
                    item.name.toLowerCase().includes(searchTerm)
                );

                if (!filteredItems.length) {
                    itemsByCategoryDiv.innerHTML = '<p style="text-align:center;color:#666; margin-top:20px;">ç™»éŒ²ã•ã‚ŒãŸé£Ÿæã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                let sortedItems = [...filteredItems];
                if (currentSortOrder === 'near-expiry') {
                    sortedItems.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                } else if (currentSortOrder === 'category') {
                    sortedItems.sort((a, b) => {
                        if (a.category < b.category) return -1;
                        if (a.category > b.category) return 1;
                        return new Date(a.expiryDate) - new Date(b.expiryDate);
                    });
                }

                // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const grouped = sortedItems.reduce((acc, item) => {
                    (acc[item.category] ||= []).push(item);
                    return acc;
                }, {});

                Object.keys(grouped).forEach((category) => {
                    const section = document.createElement('div');
                    section.style.marginBottom = '20px';

                    const h3 = document.createElement('h3');
                    h3.textContent = category;
                    h3.style.fontSize = '1.1em';
                    h3.style.color = '#007bff';
                    section.appendChild(h3);

                    const grid = document.createElement('div');
                    grid.className = 'items-grid';

                    grouped[category].forEach((item) => {
                        const card = document.createElement('div');
                        card.className = 'item-card';

                        // ç”»åƒ
                        if (item.image) {
                            const img = document.createElement('img');
                            img.src = item.image;
                            img.className = 'item-thumbnail';
                            card.appendChild(img);
                        } else {
                            // ãƒ€ãƒŸãƒ¼ç”»åƒé ˜åŸŸ
                            const dummy = document.createElement('div');
                            dummy.style.height = '100px';
                            dummy.style.background = '#f0f0f0';
                            dummy.style.borderRadius = '4px';
                            dummy.style.marginBottom = '5px';
                            dummy.style.display = 'flex';
                            dummy.style.alignItems = 'center';
                            dummy.style.justifyContent = 'center';
                            dummy.style.color = '#ccc';
                            dummy.textContent = 'No Image';
                            card.appendChild(dummy);
                        }

                        const nameTitle = document.createElement('h4');
                        nameTitle.textContent = item.name;
                        card.appendChild(nameTitle);

                        const expiryP = document.createElement('p');
                        expiryP.textContent = `æœŸé™: ${item.expiryDate}`;
                        card.appendChild(expiryP);

                        // æœŸé™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—
                        const status = document.createElement('span');
                        status.className = 'expiry-status';
                        const remain = daysDiff(new Date(), new Date(item.expiryDate));
                        if (remain < 0) {
                            status.textContent = `æœŸé™åˆ‡ã‚Œ ${Math.abs(remain)}æ—¥`;
                            status.classList.add('expired');
                        } else if (remain <= 3) {
                            status.textContent = `ã‚ã¨ ${remain}æ—¥`;
                            status.classList.add('near-expiry');
                        } else {
                            status.textContent = `ã‚ã¨ ${remain}æ—¥`;
                            status.classList.add('ok-expiry');
                        }
                        card.appendChild(status);

                        // å‰Šé™¤ãƒœã‚¿ãƒ³
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Ã—';
                        delBtn.className = 'delete-button';
                        delBtn.addEventListener('click', () => {
                            if (confirm(`${item.name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                                foodItems = foodItems.filter(x => x.id !== item.id);
                                localStorage.setItem('foodItems', JSON.stringify(foodItems));
                                renderItems();
                            }
                        });
                        card.appendChild(delBtn);

                        grid.appendChild(card);
                    });
                    section.appendChild(grid);
                    itemsByCategoryDiv.appendChild(section);
                });
            }

            function daysDiff(from, to) {
                const d1 = new Date(from.getFullYear(), from.getMonth(), from.getDate());
                const d2 = new Date(to.getFullYear(), to.getMonth(), to.getDate());
                return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
            }


            //é€šçŸ¥æ©Ÿèƒ½
            const reqPermBtn = document.getElementById('request-notification-permission');
            const notifStatus = document.getElementById('notification-status');

            function checkNotificationStatus() {
                if (!("Notification" in window)) {
                    notifStatus.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥éå¯¾å¿œã§ã™';
                    reqPermBtn.style.display = 'none';
                    return;
                }
                if (Notification.permission === "granted") {
                    notifStatus.textContent = 'âœ… é€šçŸ¥ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã™';
                    reqPermBtn.style.display = 'none';
                    checkAndSendNotifications();
                } else if (Notification.permission === "denied") {
                    notifStatus.textContent = 'âŒ é€šçŸ¥ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™';
                } else {
                    notifStatus.textContent = 'âš ï¸ é€šçŸ¥ã¯æœªè¨±å¯ã§ã™';
                }
            }

            reqPermBtn.addEventListener('click', () => {
                Notification.requestPermission().then(permission => {
                    checkNotificationStatus();
                });
            });

            function checkAndSendNotifications() {
                if (Notification.permission !== "granted") return;
                const today = new Date();
                const nearItems = foodItems.filter(item => {
                    const r = daysDiff(today, new Date(item.expiryDate));
                    return r >= 0 && r <= 3;
                });

                if (nearItems.length > 0) {
                    new Notification(`è³å‘³æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ`, {
                        body: `${nearItems.length}å€‹ã®é£Ÿæã®æœŸé™ãŒ3æ—¥ä»¥å†…ã«è¿«ã£ã¦ã„ã¾ã™ï¼`,
                    });
                }
            }

            // åˆæœŸåŒ–å®Ÿè¡Œ
            renderItems();
            checkNotificationStatus();
            switchSection(itemListSection, showItemListBtn);
        });
    </script>
</body>
</html>
